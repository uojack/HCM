async function loadKPI(){ const r=await fetch('/api/kpi'); const k=await r.json(); const el=document.getElementById('kpi');
  el.innerHTML = ['关键岗TTP(h): '+(k.ttp&&Math.round(k.ttp)), '全岗TTF(h): '+(k.ttf&&Math.round(k.ttf)), '72h结案率(%): '+(k.close72Rate??'—'), '在面池倍率: '+(k.poolMultiple??'—'), 'eNPS: '+(k.eNPS??'—')].map(function(x){return '<div class="card">'+x+'</div>';}).join(''); }
async function loadList(){ const r=await fetch('/api/tickets'); const list=await r.json(); const t=document.getElementById('list');
  t.innerHTML='<tr><th>ID</th><th>类型</th><th>状态</th><th>标题</th><th>操作</th></tr>'+list.map(function(x){return '<tr><td>'+x.id+'</td><td>'+x.type+'</td><td>'+x.status+'</td><td>'+x.title+'</td><td>'+(x.type==='FAIRNESS'?('<button onclick="stop(\''+x.id+'\')">开始停表</button> <button onclick="resume(\''+x.id+'\')">结束停表</button>'):'')+'</td></tr>';}).join(''); }
async function stop(id){ const reason=prompt('停表原因（如：法务审查）')||''; await fetch('/api/tickets/'+id+'/stop',{method:'POST',headers:{'content-type':'application/x-www-form-urlencoded'},body:'reason='+encodeURIComponent(reason)}); alert('已记录'); }
async function resume(id){ await fetch('/api/tickets/'+id+'/resume',{method:'POST'}); alert('已结束停表'); }
document.getElementById('newTicket').onsubmit=async function(e){e.preventDefault();const fd=new FormData(e.target); const payload=new URLSearchParams();for(const [k,v] of fd.entries()) payload.append(k,v==='on'?'true':String(v)); const r=await fetch('/api/tickets',{method:'POST',headers:{'content-type':'application/x-www-form-urlencoded'},body:payload}); if(r.status===401){alert('请先登录企业微信'); return;} await loadList(); await loadKPI(); e.target.reset();};
document.getElementById('enps').onsubmit=async function(e){e.preventDefault();const fd=new FormData(e.target); const r=await fetch('/api/enps',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({score:Number(fd.get('score')),comment:fd.get('comment')})}); if(r.status===401){alert('请先登录企业微信'); return;} alert('感谢反馈'); await loadKPI();};
loadKPI(); loadList();
